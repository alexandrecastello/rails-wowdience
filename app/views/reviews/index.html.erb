<!-- Seção Hero Minhas Avaliações -->
<div class="devise-hero-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="text-center mb-5">
          <h1 class="display-4 fw-bold text-white mb-3 hero-title">Minhas Avaliações</h1>
          <p class="lead text-white-50">Todas as suas avaliações de eventos em um só lugar</p>
          <div class="d-flex justify-content-center gap-3 mt-4">
            <%= link_to 'Compartilhe suas experiências', new_review_step1_path, class: 'btn btn-light btn-lg shadow-lg' %>
            <%= link_to 'Explorar Eventos', events_path, class: 'btn btn-outline-light btn-lg' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-5">
  <div class="row">
    <div class="col-lg-8">
      <!-- Cabeçalho das Avaliações -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 section-title">
          <i class="fas fa-list me-2 text-primary"></i>
          Suas Avaliações
        </h3>
        <div class="d-flex gap-2 view-toggle">
          <button class="btn btn-outline-secondary btn-sm" onclick="toggleView('grid')">
            <i class="fas fa-th"></i>
          </button>
          <button class="btn btn-outline-secondary btn-sm active" onclick="toggleView('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>

      <% if @reviews.any? %>
        <div class="reviews-list" id="reviews-container">
          <% @reviews.each do |review| %>
            <div class="review-item card shadow-sm border-0 mb-4 hover-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="flex-grow-1">
                    <h5 class="card-title mb-1">
                      <%= link_to review.event.name, review.event, class: 'text-decoration-none' %>
                    </h5>
                    <div class="event-meta mb-2">
                      <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        <%= review.event.start_date.strftime("%B %d, %Y") %>
                        <i class="fas fa-map-marker-alt ms-2 me-1"></i>
                        <%= review.event.location.name %>
                      </small>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <%= link_to edit_review_path(review), class: 'btn btn-outline-primary btn-sm', title: 'Editar Avaliação' do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <%= link_to review, method: :delete,
                        data: { confirm: 'Tem certeza que deseja excluir esta avaliação?' },
                        class: 'btn btn-outline-danger btn-sm', title: 'Excluir Avaliação' do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                  </div>
                </div>

                <div class="rating-section mb-3">
                  <div class="rating mb-2">
                    <%= star_rating(review.rating, 'medium') %>
                  </div>
                  <div class="rating-badge">
                    <% if review.rating >= 4 %>
                      <span class="badge bg-success">Excelente</span>
                    <% elsif review.rating >= 3 %>
                      <span class="badge bg-warning">Bom</span>
                    <% else %>
                      <span class="badge bg-danger">Ruim</span>
                    <% end %>
                  </div>
                </div>

                <div class="review-content">
                  <div class="long-text" id="review-<%= review.id %>">
                    <p class="card-text mb-3"><%= review.comment %></p>
                  </div>
                  <% if review.comment.length > 200 %>
                    <button class="read-more-btn" onclick="toggleReview(<%= review.id %>)">
                      <span id="toggle-<%= review.id %>">Ler mais</span>
                    </button>
                  <% end %>
                </div>

                <div class="review-footer d-flex justify-content-between align-items-center">
                  <div class="text-muted small">
                    <i class="fas fa-clock me-1"></i>
                    Avaliado em <%= review.created_at.strftime("%d/%m/%Y às %H:%M") %>
                  </div>
                  <div class="review-actions">
                    <%= link_to 'Ver Evento', review.event, class: 'btn btn-outline-secondary btn-sm' %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state text-center py-5">
          <div class="empty-state-icon mb-4">
            <i class="fas fa-star fa-4x text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">Ainda sem avaliações</h3>
          <p class="text-muted mb-4">Comece a compartilhar suas experiências adicionando sua primeira avaliação!</p>
          <%= link_to 'Adicionar Sua Primeira Avaliação', new_review_step1_path, class: 'btn btn-primary btn-lg' %>
        </div>
      <% end %>
    </div>

    <div class="col-lg-4">
      <!-- Estatísticas das Avaliações -->
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-gradient-primary text-white text-center">
          <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>
            Estatísticas das Avaliações
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-6">
              <h3 class="text-primary mb-1"><%= @reviews.count %></h3>
              <small class="text-muted">Total de Avaliações</small>
            </div>
            <div class="col-6">
              <h3 class="text-success mb-1">
                <%= @reviews.any? ? (@reviews.sum(:rating).to_f / @reviews.count).round(1) : 0 %>
              </h3>
              <small class="text-muted">Nota Média</small>
            </div>
          </div>

          <!-- Distribuição das Notas -->
          <div class="rating-distribution">
            <h6 class="text-muted mb-3">Distribuição das Notas</h6>
            <% [5.0, 4.5, 4.0, 3.5, 3.0, 2.5, 2.0, 1.5, 1.0, 0.5].each do |rating| %>
              <% count = @reviews.where(rating: rating).count %>
              <% percentage = @reviews.any? ? (count.to_f / @reviews.count * 100).round(1) : 0 %>
              <div class="d-flex align-items-center mb-2">
                <span class="me-2 text-muted small"><%= rating %></span>
                <div class="flex-grow-1 me-2">
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary" style="width: <%= percentage %>%"></div>
                  </div>
                </div>
                <span class="text-muted small"><%= count %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Atividade Recente -->
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-gradient-success text-white text-center">
          <h5 class="mb-0">
            <i class="fas fa-clock me-2"></i>
            Atividade Recente
          </h5>
        </div>
        <div class="card-body">
          <% if @reviews.any? %>
            <% @reviews.limit(3).each do |review| %>
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  <div class="rating-small">
                    <% review.rating.to_i.times do %>
                      <span class="star-small">★</span>
                    <% end %>
                    <% (10 - review.rating.to_i).times do %>
                      <span class="star-empty-small">☆</span>
                    <% end %>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1 small">
                    <%= link_to review.event.name, review.event, class: 'text-decoration-none' %>
                  </h6>
                  <small class="text-muted">
                    <%= review.created_at.strftime("%b %d") %>
                  </small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted text-center mb-0">Nenhuma atividade recente</p>
          <% end %>
        </div>
      </div>

      <!-- Ações Rápidas -->
      <div class="card shadow-lg border-0">
        <div class="card-body text-center">
          <h6 class="card-title">Ações Rápidas</h6>
          <div class="d-grid gap-2">
            <%= link_to 'Adicionar Nova Avaliação', new_review_step1_path, class: 'btn btn-primary' %>
            <%= link_to 'Explorar Eventos', events_path, class: 'btn btn-outline-primary' %>
            <%= link_to 'Ver Todos os Eventos', events_path, class: 'btn btn-outline-secondary' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleView(viewType) {
    const container = document.getElementById('reviews-container');
    const buttons = document.querySelectorAll('.view-toggle .btn');

    // Remove active class from all buttons
    buttons.forEach(btn => btn.classList.remove('active'));

    // Add active class to clicked button
    event.target.closest('button').classList.add('active');

    if (viewType === 'grid') {
      container.classList.add('grid-view');
      container.classList.remove('list-view');
    } else {
      container.classList.add('list-view');
      container.classList.remove('grid-view');
    }
  }

  // Initialize with list view
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('reviews-container');
    if (container) {
      container.classList.add('list-view');
    }
  });

  // Toggle review text
  function toggleReview(reviewId) {
    const reviewElement = document.getElementById('review-' + reviewId);
    const toggleElement = document.getElementById('toggle-' + reviewId);

    if (reviewElement.classList.contains('expanded')) {
      reviewElement.classList.remove('expanded');
      toggleElement.textContent = 'Ler mais';
    } else {
      reviewElement.classList.add('expanded');
      toggleElement.textContent = 'Ler menos';
    }
  }
</script>
